<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de M√∫sica y Danza</title>
    <link id="tema" rel="stylesheet" href="bootstrap.min.cerulean.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://ilovebiodanza.top/css/main.css">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/sonification.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://ilovebiodanza.top/js/musicaDB.js"></script>
    <script>const admin=false; const module="Music and dances"</script>
    <script src="https://ilovebiodanza.top/js/util.js"></script>
    <script src="https://ilovebiodanza.top/js/moverEstructuras.class.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script>const language= "es";</script>
    <script src="https://ilovebiodanza.top/js/lang.js"></script>
</head>
<body id="mb">
    <div  style="position: fixed; bottom: 10px; right: 10px; z-index: 9999;">
        <audio is="amo-biodanza-audio" analyst preload="none" id="audio-music" class="d-none"></audio>
    </div>

    <div class="container mt-4">
        <!-- Header -->
        <div class="bg-primary text-white rounded p-4 mb-4 text-center">
            <h1 class="display-5 fw-bold mb-3 lang">Yo<span class="text-danger">‚ù§</span>Biodanza</h1>
            <p class="lead mb-4">Explora nuestra üé∂ M√∫sica üéµ y üíÉ Danza üï∫</p>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="input-group input-group-lg shadow-sm">
                        <input type="text" id="searchInput" class="form-control border-0" placeholder="üîç Buscar por t√≠tulo, autor, danza o l√≠nea...">
                        <div class="input-group-append">
                            <button class="btn btn-light" type="button" onclick="playRandomMusic()">
                                <i class="bi bi-shuffle"></i>
                                <span class="badge bg-primary ms-1" id="random-monitor">0/0</span>
                            </button>  
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de Estad√≠sticas -->
        <div class="bg-light rounded p-3 mb-3 d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted" id="total-registros">Total: 0 registros</span>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filterChecked">
                <label class="form-check-label text-muted" for="filterChecked">
                    Mostrar solo seleccionados
                </label>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <nav aria-label="Navegaci√≥n de p√°ginas">
            <ul class="pagination pagination-sm justify-content-center" id="pagination">
                <!-- Los botones de paginaci√≥n se insertar√°n aqu√≠ -->
            </ul>
        </nav>

        <!-- Tabla -->
        <div class="bg-white rounded shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th width="60"></th>
                            <th onclick="sortTable('m.code')" class="sortable">C√≥digo</th>
                            <th>üé∂ M√∫sica üéµ <span onclick="sortTable('m.title')" class="sortable">T√≠tulo</span> / 
                            <span onclick="sortTable('m.author')" class="sortable">Autor</span></th>
                            <th onclick="sortTable('d.title')" class="sortable">üíÉ Danza üï∫</th>
                            <th onclick="sortTable('m.line')" class="sortable">L√≠nea</th>
                            <th width="80" class="text-center">
                                <i class="bi bi-check-square" title="Seleccionar"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <!-- Los datos se insertar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Clipboard -->
        <div class="invisible mt-3" id="clickboard">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-clipboard-check"></i>
                    <span id="selected-count">0 elementos seleccionados</span>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyToClipboard()">
                    <i class="bi bi-clipboard"></i> Copiar al portapapeles
                </button>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="modal fade" id="danceModal" tabindex="-1" role="dialog" aria-labelledby="danceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="danceModalLabel">Detalles de la Danza</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="danceModalBody">
                    <!-- Los detalles del danzo se insertar√°n aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="musicModal" tabindex="-1" role="dialog" aria-labelledby="musicModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="musicModalLabel">Detalles de la M√∫sica</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="musicModalBody">
                    <!-- Los detalles de la m√∫sica se insertar√°n aqu√≠ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script id="ms">
        // Variables globales
        let titles = [];
        let musics = [];
        let musicDances = [];
        let currentPage = 1;
        const limit = 30;
        let sortOrder = 'asc';
        let currentSortField = '';
        let filteredMusicDances = [];
        let dataRandom = [];
        const mvst = new MoverEstructuras("0a1Ab@Bc#C2d$De%EfF^gG&hH3iI(Jj4)k-KlLm5Mn+NoOpPq6Q]rRSs}t|TuU;V7v:w8WxX9'y,Y=Zz<>?/`~ !_*[{");
        let playedMusic = [];

        // Funciones de carga de datos
        async function cargarDatos(jsonFile) {
            try {
                const response = await fetch(jsonFile);
                if (!response.ok) throw new Error('Error en la red');
                return await response.json();
            } catch (error) {
                console.error('Hubo un problema con la solicitud Fetch:', error);
            }
        }

        async function cargarYProcesarDatos(baseUrl, tipo, procesarDatos) {
            let part = 1;
            let morePartsAvailable = true;

            while (morePartsAvailable) {
                const url = `${baseUrl}${tipo}_part${part}.json`;
                const data = await cargarDatos(url);

                if (!data || data.length === 0) {
                    morePartsAvailable = false;
                } else {
                    procesarDatos(data);
                    part++;
                }
            }
        }

        const procesarTitles = (data) => {
            titles = [...titles, ...data];
        };

        const procesarMusics = (data) => {
            musics = [...musics, ...data];
        };

        const mostrarIndice = async () => {
            await cargarYProcesarDatos('https://ilovebiodanza.github.io/catalogo/data/', 'Title', procesarTitles);
            await cargarYProcesarDatos('https://ilovebiodanza.github.io/catalogo/data/', 'Music', procesarMusics);
            
            titles.forEach((t) => {
                t.musics.forEach((m) => {
                    const music = musics.find(music => music._id === m.id);
                    if (music) {
                        musicDances.push({
                            m: {
                                id: music._id,
                                code: music.code,
                                title: music.title,
                                author: music.author,
                                line: music.line,
                                mp3: music.mp3,
                                ogg: music.ogg,
                                wd: (music.description.length > 20) ? music._id : ''
                            },
                            d: { id: t._id, title: t.title, dance: t.musics[0].d },
                            checked: false
                        });
                    }
                });
            });

            // Ordenamientos
            musicDances.sort((a, b) => {
                const aKey = a.m.title + a.m.author + (a.m.wd === '' ? "1" : "0");
                const bKey = b.m.title + b.m.author + (b.m.wd === '' ? "1" : "0");
                return aKey.localeCompare(bKey);
            });

            for (let i = 1; i < musicDances.length; i++) {
                if (musicDances[i - 1].m.title + musicDances[i - 1].m.author === musicDances[i].m.title + musicDances[i].m.author) {
                    musicDances[i].m.wd = musicDances[i - 1].m.wd;
                }
            }

            musicDances.sort((a, b) => {
                const aKey = a.d.id + a.m.code + (a.m.wd === '' ? "1" : "0");
                const bKey = b.d.id + b.m.code + (b.m.wd === '' ? "1" : "0");
                return aKey.localeCompare(bKey);
            });

            musicDances = musicDances.filter((item, index, self) =>
                index === 0 || (item.m.code+item.d._id) !== (self[index - 1].m.code+self[index - 1].d._id)
            );

            musicDances.sort((a, b) => {
                const aKey = a.d.title + a.m.title + a.m.author;
                const bKey = b.d.title + b.m.title + b.m.author;
                return aKey.localeCompare(bKey);
            });

            renderTable();
            renderPagination();
            updateStats();
        };

        // Funci√≥n para actualizar estad√≠sticas
        const updateStats = () => {
            const total = musicDances.length;
            const filtered = getPage(document.getElementById('searchInput').value, limit, currentPage).length;
            document.getElementById('total-registros').textContent = `Total: ${total} registros | Mostrando: ${filtered}`;
            
            const selectedCount = musicDances.filter(item => item.checked).length;
            document.getElementById('selected-count').textContent = `${selectedCount} elementos seleccionados`;
        };

        // Funci√≥n para aplicar clases de ordenamiento
        const updateSortIndicators = (field) => {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const header = document.querySelector(`th[onclick="sortTable('${field}')"]`);
            if (header) {
                header.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        };

        // Funci√≥n de ordenamiento
        const sortTable = (field) => {
            if (currentSortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                sortOrder = 'asc';
            }
            
            const aField = field.split('.');
            
            musicDances.sort((a, b) => {
                let valueA = a[aField[0]][aField[1]];
                let valueB = b[aField[0]][aField[1]];
                
                if (!valueA) valueA = '';
                if (!valueB) valueB = '';
                
                const comparison = valueA.toString().localeCompare(valueB.toString());
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            updateSortIndicators(field);
            renderTable(document.getElementById('searchInput').value);
            renderPagination();
        };

        // Funciones de b√∫squeda y filtrado
        const regExpSearchValue = (searchValue) => {
            let regex = searchValue
                .replace(/[a√°]/gi, '[a√°]')
                .replace(/[e√©]/gi, '[e√©]')
                .replace(/[i√≠]/gi, '[i√≠]')
                .replace(/[o√≥]/gi, '[o√≥]')
                .replace(/[u√∫√º]/gi, '[u√∫√º]');
            return new RegExp(regex, 'gi');
        };

        const getPage = (searchedValue, limit, page) => {
            const searchTerms = searchedValue.split(" ");
            const regTerms = searchTerms.map(regExpSearchValue);
            const fullfield = (item) => `${item.m.code} ${item.m.title} ${item.m.author} ${item.m.line} ${item.d.title}`;

            const isCheckedFilter = document.getElementById('filterChecked').checked;

            const filteredData = musicDances.filter(item => 
                (!isCheckedFilter || item.checked) && 
                regTerms.every(term => fullfield(item).toLowerCase().match(term))
            );
            const startIndex = limit * (page - 1);

            if (isCheckedFilter) {
                filteredMusicDances = filteredData.map(item => ({
                    m: {
                        id: item.m.id,
                        code: item.m.code,
                        title: item.m.title,
                        author: item.m.author,
                        line: item.m.line
                    },
                    d: {
                        id: item.d.dance,
                        title: item.d.title
                    }
                }));
                document.querySelector('#clickboard').classList.remove('invisible');
            } else {
                filteredMusicDances = [];
                document.querySelector('#clickboard').classList.add('invisible');
            }

            dataRandom = eliminarMusicasDuplicadas(filteredData);
            playedMusic = [];
            document.getElementById('random-monitor').textContent = `${playedMusic.length} / ${dataRandom.length}`;

            return filteredData.slice(startIndex, startIndex + limit);
        };

        // Funci√≥n para copiar al portapapeles
        const copyToClipboard = () => {
            const headers = "ID Musica\tCodigo\tTitulo\tAutor\tLinea\tID Danza\tTitulo Danza";
            const textToCopy = filteredMusicDances.map(item => 
                `${item.m.id}\t${item.m.code}\t${item.m.title}\t${item.m.author}\t${item.m.line}\t${item.d.id}\t${item.d.title}`
            ).join('\n');

            const fullText = `${headers}\n${textToCopy}`;

            navigator.clipboard.writeText(fullText).then(() => {
                alert('Las danzas y m√∫sicas seleccionadas han sido copiadas al portapapeles.');
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        };

        // Funci√≥n para cambiar el estado de los checkboxes
        const changeChecked = (danceId, musicId, isChecked) => {
            const item = musicDances.find(i => i.d.id === danceId && i.m.id === musicId);
            if (item) {
                item.checked = isChecked;
                renderTable(document.getElementById('searchInput').value);
                renderPagination();
                updateStats();
            }
        };

        // Funciones auxiliares
        const shortLine = (line) => {
            return getPotencialsIcons(line);
            let newLine = line.replace("Afectividad", "AF");
            newLine = newLine.replace("Sexualidad", "SX");
            newLine = newLine.replace("Vitalidad", "VT");
            newLine = newLine.replace("Trascendencia", "TR");
            newLine = newLine.replace("Creatividad", "CR");
            return newLine;
        };

        const lapm = (id, mId) => {
            const m = musics.find(music => music._id === mId);
            loadAndPlayMusic(id, mvst.des(m.code,m.mp3), mvst.des(m.code,m.ogg), m.code, m.title, m.author);
        };

        // Renderizado de tabla
        const renderTable = (searchedValue = '') => {
            const dataTable = document.getElementById('dataTable');
            dataTable.innerHTML = '';

            const paginatedData = getPage(searchedValue, limit, currentPage);
            
            if (paginatedData.length === 0) {
                dataTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-search display-4 text-muted"></i>
                            <p class="mt-2 text-muted">No se encontraron resultados</p>
                        </td>
                    </tr>
                `;
            } else {
                paginatedData.forEach(item => {
                    const row = `
                    <tr>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="lapm('audio-music','${item.m.id}')">
                                <i class="bi bi-music-note-beamed"></i>
                            </button>
                        </td>
                        <td nowrap style="cursor:pointer" class="${item.m.wd !== '' ? 'fw-bold text-dark danzo' : 'fw-bold text-dark'}" 
                            ${item.m.wd !== '' ? `onclick="showMusicDetails('${item.m.wd}')"` : ''}>
                            ${item.m.code}
                            ${item.m.wd !== '' ? '<i class="bi bi-info-circle text-info ms-1"></i>' : ''}
                        </td>
                        <td class="small">
                            ${item.m.title}</br>
                            ${item.m.author}
                        </td>
                        <td style="cursor:pointer" class="text-primary danzo" onclick="showDanceDetails('${item.d.id}')">
                            ${item.d.title}
                        </td>
                        <td nowrap>
                            <span class="badge bg-secondary">${shortLine(item.m.line)}</span>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input" 
                                   onclick="changeChecked('${item.d.id}','${item.m.id}',this.checked)" 
                                   ${item.checked ? 'checked' : ''}>
                        </td>
                    </tr>`;
                    dataTable.innerHTML += row;
                });
            }
            
            updateStats();
        };

        // Paginaci√≥n
        const renderPagination = () => {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(musicDances.length / limit);
            const maxButtons = 5;

            if (totalPages <= 1) return;

            // Bot√≥n Primera P√°gina
            pagination.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(1)" title="Primera p√°gina">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>
                </li>
            `;

            // Bot√≥n Anterior
            pagination.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" title="P√°gina anterior">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // Botones de p√°ginas
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // Bot√≥n Siguiente
            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" title="P√°gina siguiente">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            // Bot√≥n √öltima P√°gina
            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${totalPages})" title="√öltima p√°gina">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
            `;
        };

        const changePage = (page) => {
            currentPage = page;
            renderTable(document.getElementById('searchInput').value);
            renderPagination();
        };

        // Funciones de los modales
        const showDanceDetails = (id) => {
            const modalBody = document.getElementById('danceModalBody');
            const dance = titles.find(title => title._id === id);

            modalBody.innerHTML = `
                <p><strong>Danza:</strong> ${dance.title}</p>
                <p><strong>Descripci√≥n:</strong> ${mvst.des(id,dance.description)}</p>
            `;
            $('#danceModal').modal('show');
        };

        const showMusicDetails = (id) => {
            const modalBody = document.getElementById('musicModalBody');
            const music = musics.find(music => music._id === id);

            modalBody.innerHTML = `
                <p><strong>Music:</strong> ${music.title} - ${music.author}</p>
                <p><strong>Descripci√≥n:</strong> ${mvst.des(music.code,music.description)}</p>
            `;
            $('#musicModal').modal('show');
        };

        // Funci√≥n para eliminar elementos duplicados
        function eliminarMusicasDuplicadas(musicList) {
            const uniqueMusic = [];
            const seenMusic = new Set();
        
            for (const music of musicList) {
                if (!seenMusic.has(music.m.title+music.m.author)) {
                    uniqueMusic.push(music);
                    seenMusic.add(music.m.title+music.m.author);
                }
            }
        
            return uniqueMusic;
        }

        // Funci√≥n para reproducir m√∫sica aleatoria
        function playRandomMusic() {
            if (playedMusic.length === dataRandom.length) {
                alert('Todas las canciones han sido reproducidas.');
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * dataRandom.length);
            } while (playedMusic.includes(randomIndex));

            playedMusic.push(randomIndex);
            document.getElementById('random-monitor').textContent = `${playedMusic.length} / ${dataRandom.length}`;

            const item = dataRandom[randomIndex];
            loadAndPlayMusic('audio-music', mvst.des(item.m.code,item.m.mp3), mvst.des(item.m.code,item.m.ogg),item.m.code,item.m.title,item.m.author);
            
            setTimeout(() => document.getElementById('audio-music').onended = playRandomMusic, 2000);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('input', (event) => {
                currentPage = 1;
                renderTable(event.target.value);
                renderPagination();
            });

            document.getElementById('filterChecked').addEventListener('change', function() {
                document.getElementById('searchInput').value = '';
                currentPage = 1;
                renderTable();
                renderPagination();
            });

            document.querySelector('.btn-primary')?.addEventListener('click', copyToClipboard);

            mostrarIndice();
        });

    </script>

    <!-- Scripts adicionales -->
    <script src="https://ilovebiodanza.top/js/element.music-analyst.js"></script>
    <script src='https://ilovebiodanza.top/js/miAudio.js'></script>
    <script src='https://ilovebiodanza.top/js/audio.js'></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Script para cargar tema -->
    <script>            
        function cargarTema() {
            const urlParams = new URLSearchParams(window.location.search);
            const tema = urlParams.get('tema') || 'cerulean';
            const temasDisponibles = [
                'cerulean', 'ciborg', 'cosmo', 'darkly', 'flatly', 
                'journal', 'litera', 'lumen', 'lux', 'materia', 
                'minty', 'pulse', 'sandstone', 'simplex', 'sketchy', 
                'slate', 'solar', 'spacelab', 'superhero', 'united', 
                'yeti'
            ];
        
            if (temasDisponibles.includes(tema)) {
                document.getElementById('tema').href = `bootstrap.min.${tema}.css`;
            } else {
                console.warn('Tema no v√°lido. Se cargar√° el tema por defecto.');
            }
        }
        window.onload = cargarTema;
                document.addEventListener('DOMContentLoaded', function() {
            
            // Funci√≥n para desencriptar un texto en Base64
            function desencriptar(texto) {
                return atob(texto); // Utiliza Base64 para desencriptar
            }
            // Obtener los par√°metros de la URL
            const params = new URLSearchParams(window.location.search);
            const fechaEncriptada = params.get('ff');
            if (fechaEncriptada) {
                // Desencriptar la fecha
                const fechaDesencriptada = new Date(desencriptar(fechaEncriptada));
                // console.log(`ff ${fechaDesencriptada}`);
                // Funci√≥n para verificar si la fecha actual supera la fecha desencriptada
                function verificarFecha() {
                    const fechaActual = new Date();
                    if (fechaActual > fechaDesencriptada) {
                        document.getElementById('mb').innerHTML="";
                        window.location.href = "https://ilovebiodanza.top";
                    } else {
                        console.log("La fecha actual no ha superado la fecha recibida.");
                    }
                }
                // Verificar de inmediato
                verificarFecha();
                setInterval(verificarFecha, 300000); // Cada 5 minutos
            } else {
                document.getElementById('mb').innerHTML="";
                window.location.href = "https://ilovebiodanza.top";
            }
                
        });

    </script>
</body>
</html>
